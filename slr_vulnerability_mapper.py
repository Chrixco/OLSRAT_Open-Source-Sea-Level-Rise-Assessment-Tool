# -*- coding: utf-8 -*-
"""
/***************************************************************************
 SlrVulnerabilityMapper
                                 A QGIS plugin
 Assess and visualize sea-level-rise & flood exposure
 Generated by Plugin Builder
                              -------------------
        begin                : 2025-08-17
        copyright            : (C) 2025
        email                : christianxcorral@gmail.com
 ***************************************************************************/

/***************************************************************************
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 ***************************************************************************/
"""

__author__ = 'Christian Xavier Corral Burau'
__date__ = '2025-08-17'
__copyright__ = '(C) 2025 by Christian Xavier Corral Burau'
__revision__ = '$Format:%H$'

import processing
from collections import defaultdict
from qgis.core import QgsApplication, QgsMessageLog
from qgis.PyQt.QtWidgets import QAction, QMenu
from qgis.PyQt.QtGui import QIcon

from .slr_vulnerability_mapper_provider import SlrVulnerabilityMapperProvider, PLUGIN_ICON
from .slr_vm_new_gui import SlrVmNewGui
from . import resources_rc   # compiled from resources.qrc


class SlrVulnerabilityMapperPlugin:
    def __init__(self, iface):
        self.iface = iface
        self.provider = None
        self.menu_root = self.tr("&OSLRAT")
        self.toolbar = None
        self.plugin_menu = None
        self.actions = []
        self.gui_dialog = None  # Singleton instance of main GUI

    def tr(self, message):
        from qgis.PyQt.QtCore import QCoreApplication
        return QCoreApplication.translate("SlrVulnerabilityMapperPlugin", message)

    def initProcessing(self):
        """Register the Processing provider."""
        self.provider = SlrVulnerabilityMapperProvider()
        QgsApplication.processingRegistry().addProvider(self.provider)

    def initGui(self):
        """Set up plugin menu and toolbar actions."""
        try:
            self.initProcessing()

            # Create a custom toolbar for the plugin
            self.toolbar = self.iface.addToolBar("OSLRAT")
            self.toolbar.setObjectName("OSLRAT")

            # Create root plugin menu under Plugins
            self.plugin_menu = self.iface.pluginMenu().addMenu(PLUGIN_ICON, self.menu_root)

            # Main action: open the Toolkit GUI
            self.gui_action = QAction(PLUGIN_ICON, "OSLRAT Toolkit", self.iface.mainWindow())
            self.gui_action.setToolTip("Open OSLRAT - Open-Source Sea-Level Rise Assessment Tool")
            self.gui_action.setWhatsThis(
                "Opens the OSLRAT Toolkit with categorized tools for "
                "flood mapping, data preparation, social analysis, and terrain analysis"
            )
            self.gui_action.triggered.connect(self.open_new_gui)

            # Add action to menu and toolbar
            self.plugin_menu.addAction(self.gui_action)
            self.toolbar.addAction(self.gui_action)
            self.iface.addToolBarIcon(self.gui_action)
            self.actions.append(self.gui_action)

            # --- Optional: also add algorithms into plugin menu (not toolbar) ---
            try:
                alg_groups = defaultdict(list)
                for alg in self.provider.algorithms():
                    alg_groups[alg.group()].append(alg)

                for group_name, algs in sorted(alg_groups.items()):
                    submenu = QMenu(group_name, self.iface.mainWindow())
                    submenu.setIcon(PLUGIN_ICON)
                    self.plugin_menu.addMenu(submenu)

                    for alg in algs:
                        alg_id = f"{self.provider.id()}:{alg.name()}"
                        action = QAction(PLUGIN_ICON, alg.displayName(), self.iface.mainWindow())
                        action.triggered.connect(
                            lambda checked=False, alg_id=alg_id: processing.execAlgorithmDialog(alg_id)
                        )
                        submenu.addAction(action)
                        self.actions.append(action)
            except Exception as e:
                QgsMessageLog.logMessage(
                    f"Warning: Could not create algorithm submenus: {str(e)}",
                    "OSLRAT", level=1
                )

        except Exception as e:
            QgsMessageLog.logMessage(
                f"CRITICAL: Plugin initialization failed: {str(e)}",
                "OSLRAT", level=2
            )
            import traceback
            QgsMessageLog.logMessage(
                f"Traceback: {traceback.format_exc()}",
                "OSLRAT", level=2
            )
            raise

    def open_new_gui(self):
        """Open the new GUI dialog with category buttons (singleton pattern)."""
        try:
            # Check if dialog already exists and is visible
            if self.gui_dialog is not None:
                # Bring existing dialog to front
                self.gui_dialog.show()
                self.gui_dialog.raise_()
                self.gui_dialog.activateWindow()
                QgsMessageLog.logMessage("Reusing existing main GUI dialog", "OSLRAT", Qgis.Info)
                return

            # Create new dialog instance
            self.gui_dialog = SlrVmNewGui(self.provider, self.iface.mainWindow())

            # Cleanup reference when destroyed
            self.gui_dialog.destroyed.connect(self._on_gui_destroyed)

            # Show non-modally (preferred for QGIS - allows map interaction)
            self.gui_dialog.show()

            QgsMessageLog.logMessage("Created new main GUI dialog", "OSLRAT", Qgis.Info)

        except Exception as e:
            self.iface.messageBar().pushCritical("Error", f"Failed to open GUI: {str(e)}")
            QgsMessageLog.logMessage(f"GUI open error: {str(e)}", "OSLRAT", Qgis.Critical)

    def _on_gui_destroyed(self):
        """Cleanup GUI reference when destroyed"""
        self.gui_dialog = None
        QgsMessageLog.logMessage("Main GUI dialog destroyed", "OSLRAT", Qgis.Info)

    def unload(self):
        """Cleanup when plugin is unloaded."""
        # Close and cleanup GUI dialog if open
        if self.gui_dialog is not None:
            try:
                self.gui_dialog.close()
            except:
                pass
            self.gui_dialog = None

        if self.provider:
            QgsApplication.processingRegistry().removeProvider(self.provider)
            self.provider = None

        # Remove all toolbar icons
        for action in self.actions:
            self.iface.removeToolBarIcon(action)

        # Remove plugin menu
        if self.plugin_menu:
            self.iface.pluginMenu().removeAction(self.plugin_menu.menuAction())
            self.plugin_menu = None

        # Remove toolbar
        if self.toolbar:
            self.iface.mainWindow().removeToolBar(self.toolbar)
            self.toolbar = None
