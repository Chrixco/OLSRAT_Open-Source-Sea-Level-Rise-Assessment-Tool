# -*- coding: utf-8 -*-
"""
/***************************************************************************
 SlrVulnerabilityMapperProvider
    QGIS Processing Provider for OSLRAT - Open-Source Sea-Level Rise Assessment Tool
 Generated by QGIS Plugin Builder
                              -------------------
        begin                : 2025-08-17
        copyright            : (C) 2025
        author               : Christian Xavier Corral Burau
        email                : christianxcorral@gmail.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import os
from qgis.core import QgsProcessingProvider, QgsMessageLog
from qgis.PyQt.QtGui import QIcon


def _get_icon_path():
    """Get absolute path to plugin icon"""
    return os.path.join(os.path.dirname(__file__), "Icons", "256.png")


# Export PLUGIN_ICON at module level for use by main plugin file
PLUGIN_ICON = QIcon(_get_icon_path())

# Import all algorithms with error handling
_algorithm_imports = []
_failed_imports = []

try:
    from .scripts.alg_open_gui import AlgOpenGui
    _algorithm_imports.append(('AlgOpenGui', AlgOpenGui))
except Exception as e:
    _failed_imports.append(('AlgOpenGui', str(e)))

try:
    from .scripts.alg_fetch_dem import AlgFetchDEM
    _algorithm_imports.append(('AlgFetchDEM', AlgFetchDEM))
except Exception as e:
    _failed_imports.append(('AlgFetchDEM', str(e)))

try:
    from .scripts.alg_fetch_osm_data import AlgFetchOSMData
    _algorithm_imports.append(('AlgFetchOSMData', AlgFetchOSMData))
except Exception as e:
    _failed_imports.append(('AlgFetchOSMData', str(e)))

try:
    from .scripts.alg_inundation import AlgInundation
    _algorithm_imports.append(('AlgInundation', AlgInundation))
except Exception as e:
    _failed_imports.append(('AlgInundation', str(e)))

try:
    from .scripts.alg_svi import AlgSVI
    _algorithm_imports.append(('AlgSVI', AlgSVI))
except Exception as e:
    _failed_imports.append(('AlgSVI', str(e)))

try:
    from .scripts.alg_point_inundation import AlgPointFlooding
    _algorithm_imports.append(('AlgPointFlooding', AlgPointFlooding))
except Exception as e:
    _failed_imports.append(('AlgPointFlooding', str(e)))

try:
    from .scripts.alg_point_flood_heatmap import AlgPointFloodHeatmap
    _algorithm_imports.append(('AlgPointFloodHeatmap', AlgPointFloodHeatmap))
except Exception as e:
    _failed_imports.append(('AlgPointFloodHeatmap', str(e)))

try:
    from .scripts.alg_slope import AlgSlope
    _algorithm_imports.append(('AlgSlope', AlgSlope))
except Exception as e:
    _failed_imports.append(('AlgSlope', str(e)))

try:
    from .scripts.alg_hillshade import AlgHillshade
    _algorithm_imports.append(('AlgHillshade', AlgHillshade))
except Exception as e:
    _failed_imports.append(('AlgHillshade', str(e)))

try:
    from .scripts.alg_aspect import AlgAspect
    _algorithm_imports.append(('AlgAspect', AlgAspect))
except Exception as e:
    _failed_imports.append(('AlgAspect', str(e)))

try:
    from .scripts.alg_flood_scenario_generator import AlgIPCCScenarios
    _algorithm_imports.append(('AlgIPCCScenarios', AlgIPCCScenarios))
except Exception as e:
    _failed_imports.append(('AlgIPCCScenarios', str(e)))

try:
    from .scripts.alg_reproject_vector import AlgReprojectVector
    _algorithm_imports.append(('AlgReprojectVector', AlgReprojectVector))
except Exception as e:
    _failed_imports.append(('AlgReprojectVector', str(e)))

try:
    from .scripts.alg_vector_to_raster import AlgVectorToRaster
    _algorithm_imports.append(('AlgVectorToRaster', AlgVectorToRaster))
except Exception as e:
    _failed_imports.append(('AlgVectorToRaster', str(e)))

try:
    from .scripts.alg_raster_to_vector import AlgRasterToVector
    _algorithm_imports.append(('AlgRasterToVector', AlgRasterToVector))
except Exception as e:
    _failed_imports.append(('AlgRasterToVector', str(e)))

try:
    from .scripts.alg_dem_flood_scenario import DemFloodScenarioAlgorithm
    _algorithm_imports.append(('DemFloodScenarioAlgorithm', DemFloodScenarioAlgorithm))
except Exception as e:
    _failed_imports.append(('DemFloodScenarioAlgorithm', str(e)))

try:
    from .scripts.alg_dem_flood_scenario_codec import DemFloodScenarioAlgorithmWithReturnPeriod
    _algorithm_imports.append(('DemFloodScenarioAlgorithmWithReturnPeriod', DemFloodScenarioAlgorithmWithReturnPeriod))
except Exception as e:
    _failed_imports.append(('DemFloodScenarioAlgorithmWithReturnPeriod', str(e)))

try:
    from .scripts.alg_inundation_heatmap_viz import AlgInundationHeatmapViz
    _algorithm_imports.append(('AlgInundationHeatmapViz', AlgInundationHeatmapViz))
except Exception as e:
    _failed_imports.append(('AlgInundationHeatmapViz', str(e)))

try:
    from .scripts.alg_area_comparison import AlgAreaComparison
    _algorithm_imports.append(('AlgAreaComparison', AlgAreaComparison))
except Exception as e:
    _failed_imports.append(('AlgAreaComparison', str(e)))

try:
    from .scripts.alg_feature_comparison import AlgFeatureComparison
    _algorithm_imports.append(('AlgFeatureComparison', AlgFeatureComparison))
except Exception as e:
    _failed_imports.append(('AlgFeatureComparison', str(e)))

try:
    from .scripts.alg_population_impact import AlgPopulationImpact
    _algorithm_imports.append(('AlgPopulationImpact', AlgPopulationImpact))
except Exception as e:
    _failed_imports.append(('AlgPopulationImpact', str(e)))

# Log any failed imports
if _failed_imports:
    for name, error in _failed_imports:
        QgsMessageLog.logMessage(
            f"Failed to import algorithm {name}: {error}",
            "OSLRAT", level=1
        )


class SlrVulnerabilityMapperProvider(QgsProcessingProvider):
    """
    Processing provider for OSLRAT - Open-Source Sea-Level Rise Assessment Tool
    """

    def __init__(self):
        super().__init__()

    def loadAlgorithms(self, config=None):
        """
        Add all algorithms to the provider (only those that imported successfully)
        """
        # Add all successfully imported algorithms
        for name, AlgorithmClass in _algorithm_imports:
            try:
                self.addAlgorithm(AlgorithmClass())
                QgsMessageLog.logMessage(
                    f"Successfully loaded algorithm: {name}",
                    "OSLRAT", level=0
                )
            except Exception as e:
                QgsMessageLog.logMessage(
                    f"Failed to instantiate algorithm {name}: {str(e)}",
                    "OSLRAT", level=1
                )

        # Report summary
        QgsMessageLog.logMessage(
            f"OSLRAT Provider: Loaded {len(_algorithm_imports)} algorithms, {len(_failed_imports)} failed",
            "OSLRAT", level=0
        )

    def id(self):
        """
        Unique provider id (lowercase, no spaces)
        """
        return "slr_vulnerability"

    def name(self):
        """
        Short name shown in the Processing Toolbox
        """
        return self.tr("OSLRAT")

    def longName(self):
        """
        Long descriptive name shown in Processing Provider list
        """
        return self.tr("OSLRAT - Open-Source Sea-Level Rise Assessment Tool")

    def icon(self):
        """
        Provider icon
        """
        try:
            return QIcon(":/slr_vm/Icons/256.png")
        except Exception:
            return QIcon()
